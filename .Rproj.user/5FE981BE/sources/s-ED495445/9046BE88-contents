library(corrplot)
out <- soe %>%
  dplyr::filter(Var %in% c("sst anomaly in situ","bottom temp anomaly in situ"),
                EPU %in% "MAB") %>% 
  group_by(Var, EPU) %>% 
  mutate(count = n()) %>% 
  ungroup() %>% 
  filter(count >= 10,
         !str_detect(Var,"reference"),
         !is.na(Value)) %>% #SET VARIABLE LENGTH MINIMUM
  dplyr::select(-count, -EPU) %>%
  tidyr::spread(., Var, Value) %>% 
  dplyr::select(-Time)



#Make sure only complete cases are considered
env_wide <- out[complete.cases(out),]

#Find correlation matrix and order by magnitude of first principal component
env_cor <- cor(env_wide)
env_order <- corrMatOrder(env_cor, order = "FPC")
env_out <- env_cor[env_order, env_order] #reorder

#heatmap
heatmaply(env_out,
          margins = c(10,10,40,10),
          scale_fill_gradient_fun = ggplot2::scale_fill_gradient2(trans = "reverse"),
          dendrogram = 'none',
          hide_colorbar = TRUE)
